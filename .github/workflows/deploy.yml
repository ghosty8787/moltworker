name: Deploy OpenClaw to Cloudflare Moltworker

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Workers

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Clone Moltworker
        run: |
          git clone https://github.com/cloudflare/moltworker.git moltworker-build
          cd moltworker-build
          npm install

      - name: Set secrets and deploy
        working-directory: moltworker-build
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "${{ secrets.ANTHROPIC_API_KEY }}" | npx wrangler secret put ANTHROPIC_API_KEY --name openclaw-ryan
          echo "${{ secrets.MOLTBOT_GATEWAY_TOKEN }}" | npx wrangler secret put MOLTBOT_GATEWAY_TOKEN --name openclaw-ryan
          echo "${{ secrets.TELEGRAM_BOT_TOKEN }}" | npx wrangler secret put TELEGRAM_BOT_TOKEN --name openclaw-ryan
          echo "true" | npx wrangler secret put DEV_MODE --name openclaw-ryan
          echo "pairing" | npx wrangler secret put TELEGRAM_DM_POLICY --name openclaw-ryan
          echo "10m" | npx wrangler secret put SANDBOX_SLEEP_AFTER --name openclaw-ryan
          npm run build && npx wrangler deploy --name openclaw-ryan

      - name: Done
        run: |
          echo "DEPLOYED! OpenClaw is live on Cloudflare."
          echo "Worker: openclaw-ryan"
          echo "Using Anthropic Claude API"
          echo "Container sleeps after 10m idle to save costs"
